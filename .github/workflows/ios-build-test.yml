name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'iOS/**'
      - 'SwiftUI/**'
      - '.github/workflows/ios-build-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'iOS/**'
      - 'SwiftUI/**'
      - '.github/workflows/ios-build-test.yml'

env:
  # Environment variables
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  IOS_SIMULATOR_DEVICE: iPhone 15 Pro
  IOS_SIMULATOR_VERSION: latest

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Show Xcode Version
      run: xcodebuild -version
      
    - name: Show Available Simulators
      run: |
        echo "Available iOS Simulators:"
        xcrun simctl list devices available iOS
        echo ""
        echo "Available destinations for scheme:"
        cd iOS
        xcodebuild -project CentralMosqueRochdale.xcodeproj -scheme CentralMosqueRochdale -showdestinations | grep -E "(platform|name|OS)" || true
      
    - name: Cache Derived Data
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-data-${{ hashFiles('**/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-derived-data-
          
    - name: Setup iOS Simulator
      run: |
        # Get the latest available iOS simulator
        LATEST_IOS=$(xcrun simctl list runtimes | grep iOS | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
        echo "Latest iOS runtime: $LATEST_IOS"
        
        # Try to find iPhone 15 Pro, fallback to iPhone 14 Pro, then any iPhone
        DEVICE_TYPE=$(xcrun simctl list devicetypes | grep -E "iPhone (15|14|13) Pro" | head -1 | sed 's/.*(\(.*\))/\1/' || echo "com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro")
        
        if [ -z "$DEVICE_TYPE" ]; then
          DEVICE_TYPE="com.apple.CoreSimulator.SimDeviceType.iPhone-14-Pro"
        fi
        
        echo "Using device type: $DEVICE_TYPE"
        
        # Create simulator if needed
        xcrun simctl create "GitHub Actions iPhone" "$DEVICE_TYPE" | head -1 || true
        
    - name: Build iOS App
      run: |
        cd iOS
        # Use generic iOS Simulator destination
        xcodebuild \
          -project CentralMosqueRochdale.xcodeproj \
          -scheme CentralMosqueRochdale \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Debug \
          -derivedDataPath DerivedData \
          clean build \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty && exit ${PIPESTATUS[0]}
          
    - name: Run Unit Tests
      run: |
        cd iOS
        # Find an available simulator for testing
        AVAILABLE_SIMULATOR=$(xcrun simctl list devices available | grep iPhone | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
        if [ -n "$AVAILABLE_SIMULATOR" ]; then
          echo "Using simulator: $AVAILABLE_SIMULATOR"
          xcodebuild \
            -project CentralMosqueRochdale.xcodeproj \
            -scheme CentralMosqueRochdale \
            -destination "id=$AVAILABLE_SIMULATOR" \
            -configuration Debug \
            -derivedDataPath DerivedData \
            test \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]} || echo "No tests found or tests failed"
        else
          echo "No suitable simulator found for testing"
        fi
          
    - name: Archive Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          iOS/DerivedData/Logs/
          ~/Library/Developer/Xcode/DerivedData/*/Logs/
        retention-days: 5
        
    - name: Lint Swift Code
      run: |
        # Install SwiftLint if available
        if command -v swiftlint &> /dev/null; then
          cd iOS
          swiftlint --strict
        else
          echo "SwiftLint not installed - skipping linting"
        fi
      continue-on-error: true
      
    - name: Check Code Formatting
      run: |
        # Install swift-format if available  
        if command -v swift-format &> /dev/null; then
          cd iOS
          find . -name "*.swift" -exec swift-format format --in-place {} \;
          # Check if any files were changed
          if [[ -n $(git diff --name-only) ]]; then
            echo "Code formatting issues found:"
            git diff
            exit 1
          else
            echo "Code formatting is correct"
          fi
        else
          echo "swift-format not installed - skipping formatting check"
        fi
      continue-on-error: true

  build-release:
    name: Build Release Configuration
    runs-on: macos-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache Derived Data
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-data-release-${{ hashFiles('**/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-derived-data-release-
          ${{ runner.os }}-derived-data-
          
    - name: Build Release Configuration
      run: |
        cd iOS
        # Use generic iOS Simulator destination for release build
        xcodebuild \
          -project CentralMosqueRochdale.xcodeproj \
          -scheme CentralMosqueRochdale \
          -destination 'generic/platform=iOS Simulator' \
          -configuration Release \
          -derivedDataPath DerivedData \
          clean build \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty && exit ${PIPESTATUS[0]}
          
    - name: Archive App for Distribution
      run: |
        cd iOS
        xcodebuild \
          -project CentralMosqueRochdale.xcodeproj \
          -scheme CentralMosqueRochdale \
          -configuration Release \
          -derivedDataPath DerivedData \
          -archivePath "CentralMosqueRochdale.xcarchive" \
          archive \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty && exit ${PIPESTATUS[0]} || echo "Archive creation failed - continuing"
      continue-on-error: true
      
    - name: Upload Archive Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-archive
        path: iOS/CentralMosqueRochdale.xcarchive
        retention-days: 30

  security-scan:
    name: Security and Quality Checks
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Run Security Scan
      run: |
        # Check for hardcoded secrets, API keys, etc.
        echo "Scanning for potential security issues..."
        
        # Check for common security anti-patterns
        if grep -r "http://" iOS/ --include="*.swift" --include="*.plist"; then
          echo "Warning: Found HTTP URLs - consider using HTTPS"
        fi
        
        # Check for hardcoded API keys or secrets
        if grep -r -i "api_key\|secret\|password\|token" iOS/ --include="*.swift" --exclude-dir=DerivedData; then
          echo "Warning: Found potential hardcoded secrets"
        fi
        
        # Check Info.plist for security configurations
        if [ -f "iOS/Info.plist" ]; then
          echo "Checking Info.plist security settings..."
          if ! grep -q "NSAppTransportSecurity" iOS/Info.plist; then
            echo "Warning: App Transport Security not configured"
          fi
        fi
      continue-on-error: true
      
    - name: Check Dependencies
      run: |
        cd iOS
        # List any Swift Package Manager dependencies
        if [ -f "CentralMosqueRochdale.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved" ]; then
          echo "Swift Package Dependencies:"
          cat CentralMosqueRochdale.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved
        else
          echo "No Swift Package dependencies found"
        fi
      continue-on-error: true

  notification:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test, build-release, security-scan]
    if: always()
    
    steps:
    - name: Build Status Summary
      run: |
        echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build and Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Release | ${{ needs.build-release.result }} |" >> $GITHUB_STEP_SUMMARY  
        echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          echo "✅ iOS build completed successfully!"
        else
          echo "❌ iOS build failed!"
        fi